name: release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Test
        run: go test ./...

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Govulncheck
        run: govulncheck ./...

      - name: Build
        run: go build ./...

      - name: Compute next version and changelog
        id: rel
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail

          current_tag=$(go tool svu current 2>/dev/null || true)
          if [[ -z "$current_tag" ]]; then
            range="HEAD"
            count=$(git rev-list --count "$range")
            if [[ "$count" == "0" ]]; then
              echo "should_release=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            next_version="0.1.0"
          else
            range="${current_tag}..HEAD"
            count=$(git rev-list --count "$range")
            if [[ "$count" == "0" ]]; then
              echo "should_release=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            next_tag=$(go tool svu next)
            if [[ "$next_tag" == "$current_tag" ]]; then
              echo "should_release=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            next_version="${next_tag#v}"
          fi

          echo "next_version=$next_version" >> "$GITHUB_OUTPUT"
          echo "should_release=true" >> "$GITHUB_OUTPUT"

          date=$(date -u +%Y-%m-%d)
          notes_file="$RUNNER_TEMP/RELEASE_NOTES.md"
          header="## v${next_version} - ${date}"

          features=""
          fixes=""
          breaking_notes=""
          others=""

          re_breaking='^[A-Za-z]+(\([^)]*\))?!:'
          re_feat='^feat(\([^)]*\))?:'
          re_fix='^(fix|perf)(\([^)]*\))?:'

          while IFS= read -r line; do
            if [[ -z "$line" ]]; then
              continue
            fi
            if [[ "$line" =~ $re_breaking ]]; then
              breaking_notes+="- ${line}\n"
            elif [[ "$line" =~ $re_feat ]]; then
              features+="- ${line}\n"
            elif [[ "$line" =~ $re_fix ]]; then
              fixes+="- ${line}\n"
            else
              others+="- ${line}\n"
            fi
          done < <(git log --format=%s "$range")

          {
            echo "$header"
            if [[ -n "$breaking_notes" ]]; then
              echo
              echo "### Breaking Changes"
              echo -e "$breaking_notes"
            fi
            if [[ -n "$features" ]]; then
              echo
              echo "### Features"
              echo -e "$features"
            fi
            if [[ -n "$fixes" ]]; then
              echo
              echo "### Fixes"
              echo -e "$fixes"
            fi
            if [[ -n "$others" ]]; then
              echo
              echo "### Other"
              echo -e "$others"
            fi
          } > "$notes_file"

          if [[ -f CHANGELOG.md ]]; then
            { cat "$notes_file"; echo; cat CHANGELOG.md; } > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
          else
            cp "$notes_file" CHANGELOG.md
          fi

      - name: Bump module path for major releases
        if: steps.rel.outputs.should_release == 'true'
        uses: ./.github/actions/bump-go-module-major
        with:
          version: ${{ steps.rel.outputs.next_version }}

      - name: Commit release changes and tag
        if: steps.rel.outputs.should_release == 'true'
        env:
          NEXT_VERSION: ${{ steps.rel.outputs.next_version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md go.mod
          if [[ -f go.sum ]]; then
            git add go.sum
          fi
          git add -u

          git commit -m "chore(release): v${NEXT_VERSION}" || true

          git tag -a "v${NEXT_VERSION}" -m "v${NEXT_VERSION}"
          git push origin HEAD:main
          git push origin "v${NEXT_VERSION}"

      - name: Run GoReleaser
        if: steps.rel.outputs.should_release == 'true'
        uses: goreleaser/goreleaser-action@v5
        with:
          version: v2.12.5
          args: release --clean --release-notes ${{ runner.temp }}/RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
